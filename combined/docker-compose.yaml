services:

  # --- AI Interfaces & Orchestration ---
  openwebui:
    image: ghcr.io/open-webui/open-webui:cuda
    container_name: openwebui
    ports:
      - "3000:8080"
    volumes:
      - ${BASE_DIR}/openwebui/data:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - COMFYUI_BASE_URL=http://comfyui:8188
      - WEBUI_AUTH=false
      - ENABLE_RAG_WEB_SEARCH=True
      - RAG_WEB_SEARCH_ENGINE=searxng
      - SEARXNG_QUERY_URL=http://searxng:8080/search?format=json&q=<query>
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - searxng
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: always

  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: anythingllm
    ports:
      - "3001:3001"
    environment:
      - VECTOR_DB_TYPE=qdrant
      - VECTOR_DB_HOST=qdrant
      - VECTOR_DB_PORT=6333
      - VECTOR_DB_API_KEY=qdrant
      - EXTERNAL_LLM_ENDPOINT=http://host.docker.internal:11434
      - EXTERNAL_LLM_MODEL=qwen3-coder:latest
      - STORAGE_DIR=/app/server/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ${BASE_DIR}:/anythingLLM/app/server/storage
      - ${BASE_DIR}/anythingLLM/hotdir:/app/collector/hotdir
      - ./anythingLLM/.env:/app/server/.env # Is subfolder under docker-compose.yaml location
    depends_on:
      - qdrant
    restart: unless-stopped

  # --- Image Generation ---
  comfyui:
    image: ghcr.io/ai-dock/comfyui:latest-cuda
    container_name: comfyui
    ports:
      - "8188:8188"
    environment:
      - COMFYUI_PORT_HOST=8188
      - WEB_ENABLE_AUTH=false
    volumes:
volumes:
      # Map models so your Flux/Juggernaut files persist
      - ${BASE_DIR}/comfyui/models:/opt/ComfyUI/models
      
      # Map custom_nodes so your GGUF node survives a restart
      - ${BASE_DIR}/comfyui/custom_nodes:/opt/ComfyUI/custom_nodes
      
      # Optional: Map output so your generated images are on your host
      - ${BASE_DIR}/comfyui/output:/opt/ComfyUI/output

      # Optional: Map workflow so your saved workflows persist
      - /home/tushar/data/comfyui/workflow:/opt/ComfyUI/workflow
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: always

  # --- Search & Metadata ---
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    ports:
      - "8081:8080" # Exposed on 8081 to avoid conflict with OpenWebUI's internal 8080
    volumes:
      - ./searxng:/etc/searxng # Is subfolder under docker-compose.yaml location
    environment:
      - SEARXNG_BASE_URL=http://localhost:8081/
      - SEARXNG_REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    restart: always

  # --- Databases ---
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ${BASE_DIR}/qdrant/storage:/qdrant/storage
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --save 60 1 --loglevel warning
    restart: always
